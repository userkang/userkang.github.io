<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>userkang&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这里是userkang的blog，记录生活，分享技术">
<meta name="keywords" content="userkang">
<meta property="og:type" content="website">
<meta property="og:title" content="userkang&#39;s blog">
<meta property="og:url" content="http://userkang.com/index.html">
<meta property="og:site_name" content="userkang&#39;s blog">
<meta property="og:description" content="这里是userkang的blog，记录生活，分享技术">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="userkang&#39;s blog">
<meta name="twitter:description" content="这里是userkang的blog，记录生活，分享技术">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">userkang&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">less is more</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://userkang.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-zepto源码阅读第四天" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/22/zepto源码阅读第四天/" class="article-date">
  <time datetime="2018-06-21T16:53:12.000Z" itemprop="datePublished">2018-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/22/zepto源码阅读第四天/">zepto源码阅读第四天</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天把 $.fn 的其余函数一起列出来哈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>: function(idx)&#123;</span><br><span class="line">   <span class="comment">// 可选，不传时，将Zetpo转换成数组</span></span><br><span class="line">   <span class="keyword">return</span> idx === <span class="literal">undefined</span> ? slice.call(<span class="keyword">this</span>) : <span class="keyword">this</span>[idx &gt;= <span class="number">0</span> ? idx : idx + <span class="keyword">this</span>.length]</span><br><span class="line"> &#125;,</span><br><span class="line"> toArray: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.get() &#125;,</span><br><span class="line"> size: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.length</span><br><span class="line"> &#125;,</span><br><span class="line"> remove: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.parentNode != <span class="literal">null</span>)</span><br><span class="line">       <span class="keyword">this</span>.parentNode.removeChild(<span class="keyword">this</span>)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">// 遍历集合，将集合中的每一项放入callback中进行处理，如果callback返回false，那么就会停止循环了</span></span><br><span class="line"> each: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">   emptyArray.every.call(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">el, idx</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> callback.call(el, idx, el) !== <span class="literal">false</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line"> &#125;,</span><br><span class="line"> filter: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// this.not(selector)取到需要排除的集合，第二次再取反(这个时候this.not的参数就是一个集合了)，得到想要的集合</span></span><br><span class="line">   <span class="keyword">if</span> (isFunction(selector)) <span class="keyword">return</span> <span class="keyword">this</span>.not(<span class="keyword">this</span>.not(selector))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 原生filter如果返回true就收集</span></span><br><span class="line">   <span class="keyword">return</span> $(filter.call(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">element</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// 如果匹配就返回true</span></span><br><span class="line">     <span class="keyword">return</span> zepto.matches(element, selector)</span><br><span class="line">   &#125;))</span><br><span class="line"> &#125;,</span><br><span class="line"> add: <span class="function"><span class="keyword">function</span>(<span class="params">selector,context</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 合并后并保证唯一</span></span><br><span class="line">   <span class="keyword">return</span> $(uniq(<span class="keyword">this</span>.concat($(selector,context))))</span><br><span class="line"> &#125;,</span><br><span class="line"> is: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">typeof</span> selector == <span class="string">'string'</span> ? <span class="keyword">this</span>.length &gt; <span class="number">0</span> &amp;&amp; zepto.matches(<span class="keyword">this</span>[<span class="number">0</span>], selector) : </span><br><span class="line">       selector &amp;&amp; <span class="keyword">this</span>.selector == selector.selector</span><br><span class="line"> &#125;,</span><br><span class="line"> not: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> nodes=[]</span><br><span class="line">   <span class="comment">// 当selector为函数时，safari下的typeof nodeList也是function，所以这里需要再加一个判断selector.call !== undefined</span></span><br><span class="line">   <span class="keyword">if</span> (isFunction(selector) &amp;&amp; selector.call !== <span class="literal">undefined</span>)</span><br><span class="line">     <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="comment">// 注意这里收集的是selector.call(this,idx)返回结果为false的时候记录</span></span><br><span class="line">       <span class="keyword">if</span> (!selector.call(<span class="keyword">this</span>,idx)) nodes.push(<span class="keyword">this</span>)</span><br><span class="line">     &#125;)</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// 当selector为nodeList时执行slice.call(selector),注意这里的isFunction(selector.item)是为了排除selector为数组的情况</span></span><br><span class="line">     <span class="comment">// 当selector为css选择器，执行$(selector)</span></span><br><span class="line">     <span class="keyword">var</span> excludes = <span class="keyword">typeof</span> selector == <span class="string">'string'</span> ? <span class="keyword">this</span>.filter(selector) :</span><br><span class="line">       (likeArray(selector) &amp;&amp; isFunction(selector.item)) ? slice.call(selector) : $(selector)</span><br><span class="line">     <span class="keyword">this</span>.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">el</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (excludes.indexOf(el) &lt; <span class="number">0</span>) nodes.push(el)</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 由于上面得到的结果是数组，这里需要转成zepto对象，以便继承其它方法，实现链写</span></span><br><span class="line">   <span class="keyword">return</span> $(nodes)</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">   接收node和string作为参数，给当前集合筛选出包含selector的集合</span></span><br><span class="line"><span class="comment">   isObject(selector)是判断参数是否是node，因为typeof node == 'object'</span></span><br><span class="line"><span class="comment">   当参数为node时，只需要判读当前记当里是否包含node节点即可</span></span><br><span class="line"><span class="comment">   当参数为string时，则在当前记录里查询selector，如果长度为0，则为false，filter函数就会过滤掉这条记录，否则保存该记录</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"> has: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.filter(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> isObject(selector) ?</span><br><span class="line">       $.contains(<span class="keyword">this</span>, selector) :</span><br><span class="line">       $(<span class="keyword">this</span>).find(selector).size()</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> eq: <span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 取Zepto中的指定索引的元素，再包装成Zepto返回</span></span><br><span class="line">   <span class="keyword">return</span> idx === <span class="number">-1</span> ? <span class="keyword">this</span>.slice(idx) : <span class="keyword">this</span>.slice(idx, + idx + <span class="number">1</span>)</span><br><span class="line"> &#125;,</span><br><span class="line"> first: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> el = <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">   <span class="comment">// 这里不知道什么时候isObject(el)为false，el还可以是什么类型?</span></span><br><span class="line">   <span class="keyword">return</span> el &amp;&amp; !isObject(el) ? el : $(el)</span><br><span class="line"> &#125;,</span><br><span class="line"> last: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> el = <span class="keyword">this</span>[<span class="keyword">this</span>.length - <span class="number">1</span>]</span><br><span class="line">   <span class="keyword">return</span> el &amp;&amp; !isObject(el) ? el : $(el)</span><br><span class="line"> &#125;,</span><br><span class="line"> find: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> result, $<span class="keyword">this</span> = <span class="keyword">this</span></span><br><span class="line">   <span class="keyword">if</span> (!selector) result = $()</span><br><span class="line">   <span class="comment">// 如果selector为对象，遍历selector，筛选出父级为集合中记录的selector</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> selector == <span class="string">'object'</span>)</span><br><span class="line">     result = $(selector).filter(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="keyword">var</span> node = <span class="keyword">this</span></span><br><span class="line">       <span class="comment">// 如果$.contains(parent, node)返回true，则emptyArray.some也会返回true,外层的filter则会收录该条记录</span></span><br><span class="line">       <span class="keyword">return</span> emptyArray.some.call($<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">parent</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> $.contains(parent, node)</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;)</span><br><span class="line">   <span class="comment">// 如果selector是css选择器</span></span><br><span class="line">   <span class="comment">// 如果当前集合长度为1时，调用zepto.qsa，将结果转成zepto对象</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.length == <span class="number">1</span>) result = $(zepto.qsa(<span class="keyword">this</span>[<span class="number">0</span>], selector))</span><br><span class="line">   <span class="comment">// 如果长度大于1，则调用map遍历</span></span><br><span class="line">   <span class="keyword">else</span> result = <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> zepto.qsa(<span class="keyword">this</span>, selector) &#125;)</span><br><span class="line">   <span class="keyword">return</span> result</span><br><span class="line"> &#125;,</span><br><span class="line"> closest: <span class="function"><span class="keyword">function</span>(<span class="params">selector, context</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> nodes = [], collection = <span class="keyword">typeof</span> selector == <span class="string">'object'</span> &amp;&amp; $(selector)</span><br><span class="line">   <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">_, node</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">while</span> (node &amp;&amp; !(collection ? collection.indexOf(node) &gt;= <span class="number">0</span> : zepto.matches(node, selector)))</span><br><span class="line">       node = node !== context &amp;&amp; !isDocument(node) &amp;&amp; node.parentNode</span><br><span class="line">     <span class="keyword">if</span> (node &amp;&amp; nodes.indexOf(node) &lt; <span class="number">0</span>) nodes.push(node)</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> $(nodes)</span><br><span class="line"> &#125;,</span><br><span class="line"> parents: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> ancestors = [], nodes = <span class="keyword">this</span></span><br><span class="line">   <span class="keyword">while</span> (nodes.length &gt; <span class="number">0</span>)</span><br><span class="line">     nodes = $.map(nodes, <span class="function"><span class="keyword">function</span>(<span class="params">node</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> ((node = node.parentNode) &amp;&amp; !isDocument(node) &amp;&amp; ancestors.indexOf(node) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">         ancestors.push(node)</span><br><span class="line">         <span class="keyword">return</span> node</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   <span class="keyword">return</span> filtered(ancestors, selector)</span><br><span class="line"> &#125;,</span><br><span class="line"> parent: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> filtered(uniq(<span class="keyword">this</span>.pluck(<span class="string">'parentNode'</span>)), selector)</span><br><span class="line"> &#125;,</span><br><span class="line"> children: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> filtered(<span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> children(<span class="keyword">this</span>) &#125;), selector)</span><br><span class="line"> &#125;,</span><br><span class="line"> contents: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.contentDocument || slice.call(<span class="keyword">this</span>.childNodes) &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> siblings: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> filtered(<span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params">i, el</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// 到其父元素取得所有子节点，再排除本身</span></span><br><span class="line">     <span class="keyword">return</span> filter.call(children(el.parentNode), <span class="function"><span class="keyword">function</span>(<span class="params">child</span>)</span>&#123; <span class="keyword">return</span> child!==el &#125;)</span><br><span class="line">   &#125;), selector)</span><br><span class="line"> &#125;,</span><br><span class="line"> empty: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.innerHTML = <span class="string">''</span> &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="comment">// `pluck` is borrowed from Prototype.js</span></span><br><span class="line"> pluck: <span class="function"><span class="keyword">function</span>(<span class="params">property</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> $.map(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">el</span>)</span>&#123; <span class="keyword">return</span> el[property] &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> show: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="comment">// 清除内联样式display="none"</span></span><br><span class="line">     <span class="keyword">this</span>.style.display == <span class="string">"none"</span> &amp;&amp; (<span class="keyword">this</span>.style.display = <span class="string">''</span>)</span><br><span class="line">     <span class="comment">// 计算样式display为none时，重赋显示值</span></span><br><span class="line">     <span class="keyword">if</span> (getComputedStyle(<span class="keyword">this</span>, <span class="string">''</span>).getPropertyValue(<span class="string">"display"</span>) == <span class="string">"none"</span>)</span><br><span class="line">       <span class="comment">// defaultDisplay是获取元素默认display的方法</span></span><br><span class="line">       <span class="keyword">this</span>.style.display = defaultDisplay(<span class="keyword">this</span>.nodeName)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> replaceWith: <span class="function"><span class="keyword">function</span>(<span class="params">newContent</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 将要替换内容插到被替换内容前面，然后删除被替换内容</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.before(newContent).remove()</span><br><span class="line"> &#125;,</span><br><span class="line"> wrap: <span class="function"><span class="keyword">function</span>(<span class="params">structure</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> func = isFunction(structure)</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>[<span class="number">0</span>] &amp;&amp; !func)</span><br><span class="line">     <span class="keyword">var</span> dom   = $(structure).get(<span class="number">0</span>),</span><br><span class="line">         clone = dom.parentNode || <span class="keyword">this</span>.length &gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</span><br><span class="line">     $(<span class="keyword">this</span>).wrapAll(</span><br><span class="line">       func ? structure.call(<span class="keyword">this</span>, index) :</span><br><span class="line">         clone ? dom.cloneNode(<span class="literal">true</span>) : dom</span><br><span class="line">     )</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> wrapAll: <span class="function"><span class="keyword">function</span>(<span class="params">structure</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">     $(<span class="keyword">this</span>[<span class="number">0</span>]).before(structure = $(structure))</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> children</span><br><span class="line">     <span class="comment">// drill down to the inmost element</span></span><br><span class="line">     <span class="keyword">while</span> ((children = structure.children()).length) structure = children.first()</span><br><span class="line">     $(structure).append(<span class="keyword">this</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line"> &#125;,</span><br><span class="line"> wrapInner: <span class="function"><span class="keyword">function</span>(<span class="params">structure</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> func = isFunction(structure)</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">var</span> self = $(<span class="keyword">this</span>), contents = self.contents(),</span><br><span class="line">         dom  = func ? structure.call(<span class="keyword">this</span>, index) : structure</span><br><span class="line">     contents.length ? contents.wrapAll(dom) : self.append(dom)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> unwrap: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.parent().each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     $(<span class="keyword">this</span>).replaceWith($(<span class="keyword">this</span>).children())</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line"> &#125;,</span><br><span class="line"> clone: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.cloneNode(<span class="literal">true</span>) &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> hide: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.css(<span class="string">"display"</span>, <span class="string">"none"</span>)</span><br><span class="line"> &#125;,</span><br><span class="line"> toggle: <span class="function"><span class="keyword">function</span>(<span class="params">setting</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="keyword">var</span> el = $(<span class="keyword">this</span>)</span><br><span class="line">     ;(setting === <span class="literal">undefined</span> ? el.css(<span class="string">"display"</span>) == <span class="string">"none"</span> : setting) ? el.show() : el.hide()</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> prev: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123; <span class="keyword">return</span> $(<span class="keyword">this</span>.pluck(<span class="string">'previousElementSibling'</span>)).filter(selector || <span class="string">'*'</span>) &#125;,</span><br><span class="line"> next: <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>)</span>&#123; <span class="keyword">return</span> $(<span class="keyword">this</span>.pluck(<span class="string">'nextElementSibling'</span>)).filter(selector || <span class="string">'*'</span>) &#125;,</span><br><span class="line"> html: <span class="function"><span class="keyword">function</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">in</span> <span class="built_in">arguments</span> ?</span><br><span class="line">     <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">var</span> originHtml = <span class="keyword">this</span>.innerHTML</span><br><span class="line">       $(<span class="keyword">this</span>).empty().append( funcArg(<span class="keyword">this</span>, html, idx, originHtml) )</span><br><span class="line">     &#125;) :</span><br><span class="line">     (<span class="number">0</span> <span class="keyword">in</span> <span class="keyword">this</span> ? <span class="keyword">this</span>[<span class="number">0</span>].innerHTML : <span class="literal">null</span>)</span><br><span class="line"> &#125;,</span><br><span class="line"> text: <span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">in</span> <span class="built_in">arguments</span> ?</span><br><span class="line">     <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">var</span> newText = funcArg(<span class="keyword">this</span>, text, idx, <span class="keyword">this</span>.textContent)</span><br><span class="line">       <span class="keyword">this</span>.textContent = newText == <span class="literal">null</span> ? <span class="string">''</span> : <span class="string">''</span>+newText</span><br><span class="line">     &#125;) :</span><br><span class="line">     (<span class="number">0</span> <span class="keyword">in</span> <span class="keyword">this</span> ? <span class="keyword">this</span>.pluck(<span class="string">'textContent'</span>).join(<span class="string">""</span>) : <span class="literal">null</span>)</span><br><span class="line"> &#125;,</span><br><span class="line"> attr: <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> result</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">typeof</span> name == <span class="string">'string'</span> &amp;&amp; !(<span class="number">1</span> <span class="keyword">in</span> <span class="built_in">arguments</span>)) ?</span><br><span class="line">     <span class="comment">// 仅有name，且为字符串时，表示读，直接用getAttribute(name)读</span></span><br><span class="line">     (<span class="number">0</span> <span class="keyword">in</span> <span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>[<span class="number">0</span>].nodeType == <span class="number">1</span> &amp;&amp; (result = <span class="keyword">this</span>[<span class="number">0</span>].getAttribute(name)) != <span class="literal">null</span> ? result : <span class="literal">undefined</span>) :</span><br><span class="line">     <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.nodeType !== <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">       <span class="comment">// 如果name为对象，批量设置属性</span></span><br><span class="line">       <span class="keyword">if</span> (isObject(name)) <span class="keyword">for</span> (key <span class="keyword">in</span> name) setAttribute(<span class="keyword">this</span>, key, name[key])</span><br><span class="line">       <span class="comment">// 处理value为函数 null/undefined 的情况</span></span><br><span class="line">       <span class="keyword">else</span> setAttribute(<span class="keyword">this</span>, name, funcArg(<span class="keyword">this</span>, value, idx, <span class="keyword">this</span>.getAttribute(name)))</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> removeAttr: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.nodeType === <span class="number">1</span> &amp;&amp; name.split(<span class="string">' '</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">attribute</span>)</span>&#123;</span><br><span class="line">     setAttribute(<span class="keyword">this</span>, attribute)</span><br><span class="line">   &#125;, <span class="keyword">this</span>)&#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> prop: <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>)</span>&#123;</span><br><span class="line">   name = propMap[name] || name</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">typeof</span> name == <span class="string">'string'</span> &amp;&amp; !(<span class="number">1</span> <span class="keyword">in</span> <span class="built_in">arguments</span>)) ?</span><br><span class="line">     (<span class="keyword">this</span>[<span class="number">0</span>] &amp;&amp; <span class="keyword">this</span>[<span class="number">0</span>][name]) :</span><br><span class="line">     <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (isObject(name)) <span class="keyword">for</span> (key <span class="keyword">in</span> name) <span class="keyword">this</span>[propMap[key] || key] = name[key]</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">this</span>[name] = funcArg(<span class="keyword">this</span>, value, idx, <span class="keyword">this</span>[name])</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> removeProp: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">   name = propMap[name] || name</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">delete</span> <span class="keyword">this</span>[name] &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> data: <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> attrName = <span class="string">'data-'</span> + name.replace(capitalRE, <span class="string">'-$1'</span>).toLowerCase()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> data = (<span class="number">1</span> <span class="keyword">in</span> <span class="built_in">arguments</span>) ?</span><br><span class="line">     <span class="keyword">this</span>.attr(attrName, value) :</span><br><span class="line">     <span class="keyword">this</span>.attr(attrName)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> data !== <span class="literal">null</span> ? deserializeValue(data) : <span class="literal">undefined</span></span><br><span class="line"> &#125;,</span><br><span class="line"> val: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="number">0</span> <span class="keyword">in</span> <span class="built_in">arguments</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (value == <span class="literal">null</span>) value = <span class="string">""</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.value = funcArg(<span class="keyword">this</span>, value, idx, <span class="keyword">this</span>.value)</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>[<span class="number">0</span>] &amp;&amp; (<span class="keyword">this</span>[<span class="number">0</span>].multiple ?</span><br><span class="line">        $(<span class="keyword">this</span>[<span class="number">0</span>]).find(<span class="string">'option'</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>.selected &#125;).pluck(<span class="string">'value'</span>) :</span><br><span class="line">        <span class="keyword">this</span>[<span class="number">0</span>].value)</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> offset: <span class="function"><span class="keyword">function</span>(<span class="params">coordinates</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 写入坐标</span></span><br><span class="line">   <span class="keyword">if</span> (coordinates) <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">var</span> $<span class="keyword">this</span> = $(<span class="keyword">this</span>),</span><br><span class="line">         coords = funcArg(<span class="keyword">this</span>, coordinates, index, $<span class="keyword">this</span>.offset()),</span><br><span class="line">         parentOffset = $<span class="keyword">this</span>.offsetParent().offset(),</span><br><span class="line">         props = &#123;</span><br><span class="line">           top:  coords.top  - parentOffset.top,</span><br><span class="line">           left: coords.left - parentOffset.left</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ($<span class="keyword">this</span>.css(<span class="string">'position'</span>) == <span class="string">'static'</span>) props[<span class="string">'position'</span>] = <span class="string">'relative'</span></span><br><span class="line">     $<span class="keyword">this</span>.css(props)</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="comment">// 读取坐标 取第一个元素的坐标</span></span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">this</span>.length) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">   <span class="comment">// 如果父元素是document</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">document</span>.documentElement !== <span class="keyword">this</span>[<span class="number">0</span>] &amp;&amp; !$.contains(<span class="built_in">document</span>.documentElement, <span class="keyword">this</span>[<span class="number">0</span>]))</span><br><span class="line">     <span class="keyword">return</span> &#123;<span class="attr">top</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">0</span>&#125;</span><br><span class="line">   <span class="comment">// 读取到元素相对于页面视窗的位置</span></span><br><span class="line">   <span class="keyword">var</span> obj = <span class="keyword">this</span>[<span class="number">0</span>].getBoundingClientRect()</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     left: obj.left + <span class="built_in">window</span>.pageXOffset,</span><br><span class="line">     top: obj.top + <span class="built_in">window</span>.pageYOffset,</span><br><span class="line">     width: <span class="built_in">Math</span>.round(obj.width),</span><br><span class="line">     height: <span class="built_in">Math</span>.round(obj.height)</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> css: <span class="function"><span class="keyword">function</span>(<span class="params">property, value</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 只有一个参数的时候，只读</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">arguments</span>.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">     <span class="keyword">var</span> element = <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> property == <span class="string">'string'</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!element) <span class="keyword">return</span></span><br><span class="line">       <span class="comment">// getComputedStyle是一个可以获取当前元素所有最终使用的CSS属性值。返回的是一个CSS样式声明对象([object CSSStyleDeclaration])，只读</span></span><br><span class="line">       <span class="keyword">return</span> element.style[camelize(property)] || getComputedStyle(element, <span class="string">''</span>).getPropertyValue(property)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(property)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (!element) <span class="keyword">return</span></span><br><span class="line">       <span class="keyword">var</span> props = &#123;&#125;</span><br><span class="line">       <span class="keyword">var</span> computedStyle = getComputedStyle(element, <span class="string">''</span>)</span><br><span class="line">       $.each(property, <span class="function"><span class="keyword">function</span>(<span class="params">_, prop</span>)</span>&#123;</span><br><span class="line">         props[prop] = (element.style[camelize(prop)] || computedStyle.getPropertyValue(prop))</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">return</span> props</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> css = <span class="string">''</span></span><br><span class="line">   <span class="keyword">if</span> (type(property) == <span class="string">'string'</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!value &amp;&amp; value !== <span class="number">0</span>)</span><br><span class="line">       <span class="comment">// dasherize 是将字符串转换成css属性(background-color格式）</span></span><br><span class="line">       <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.style.removeProperty(dasherize(property)) &#125;)</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">       css = dasherize(property) + <span class="string">":"</span> + maybeAddPx(property, value)</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// property 是一个对象</span></span><br><span class="line">     <span class="keyword">for</span> (key <span class="keyword">in</span> property)</span><br><span class="line">       <span class="comment">// 当property[key]的值为 null/undefined，删除属性</span></span><br><span class="line">       <span class="keyword">if</span> (!property[key] &amp;&amp; property[key] !== <span class="number">0</span>)</span><br><span class="line">         <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.style.removeProperty(dasherize(key)) &#125;)</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">         css += dasherize(key) + <span class="string">':'</span> + maybeAddPx(key, property[key]) + <span class="string">';'</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.style.cssText += <span class="string">';'</span> + css &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> index: <span class="function"><span class="keyword">function</span>(<span class="params">element</span>)</span>&#123;</span><br><span class="line">   <span class="comment">// 这里的$(element)[0]是为了将字符串转成node,因为this是个包含node的数组</span></span><br><span class="line">   <span class="comment">// 当不指定element时，取集合中第一条记录在其父节点的位置</span></span><br><span class="line">   <span class="comment">// this.parent().children().indexOf(this[0])这句很巧妙，和取第一记录的parent().children().indexOf(this)相同</span></span><br><span class="line">   <span class="keyword">return</span> element ? <span class="keyword">this</span>.indexOf($(element)[<span class="number">0</span>]) : <span class="keyword">this</span>.parent().children().indexOf(<span class="keyword">this</span>[<span class="number">0</span>])</span><br><span class="line"> &#125;,</span><br><span class="line"> hasClass: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!name) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">   <span class="comment">// some ES5的新方法 有一个匹配，即返回true</span></span><br><span class="line">   <span class="keyword">return</span> emptyArray.some.call(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">el</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// this是classRE(name)生成的正则</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>.test(className(el))</span><br><span class="line">   &#125;, classRE(name))</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">addClass: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!name) <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// 已存在，返回</span></span><br><span class="line">     <span class="keyword">if</span> (!(<span class="string">'className'</span> <span class="keyword">in</span> <span class="keyword">this</span>)) <span class="keyword">return</span></span><br><span class="line">     classList = []</span><br><span class="line">     <span class="keyword">var</span> cls = className(<span class="keyword">this</span>), newName = funcArg(<span class="keyword">this</span>, name, idx, cls)</span><br><span class="line">     <span class="comment">// 多个类，空格分隔为数组</span></span><br><span class="line">     newName.split(<span class="regexp">/\s+/g</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">klass</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!$(<span class="keyword">this</span>).hasClass(klass)) classList.push(klass)</span><br><span class="line">     &#125;, <span class="keyword">this</span>)</span><br><span class="line">     <span class="comment">// 设值</span></span><br><span class="line">     classList.length &amp;&amp; className(<span class="keyword">this</span>, cls + (cls ? <span class="string">" "</span> : <span class="string">""</span>) + classList.join(<span class="string">" "</span>))</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> removeClass: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (!(<span class="string">'className'</span> <span class="keyword">in</span> <span class="keyword">this</span>)) <span class="keyword">return</span></span><br><span class="line">     <span class="keyword">if</span> (name === <span class="literal">undefined</span>) <span class="keyword">return</span> className(<span class="keyword">this</span>, <span class="string">''</span>)</span><br><span class="line">     classList = className(<span class="keyword">this</span>)</span><br><span class="line">     funcArg(<span class="keyword">this</span>, name, idx, classList).split(<span class="regexp">/\s+/g</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">klass</span>)</span>&#123;</span><br><span class="line">       classList = classList.replace(classRE(klass), <span class="string">" "</span>)</span><br><span class="line">     &#125;)</span><br><span class="line">     className(<span class="keyword">this</span>, classList.trim())</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> toggleClass: <span class="function"><span class="keyword">function</span>(<span class="params">name, when</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!name) <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(<span class="function"><span class="keyword">function</span>(<span class="params">idx</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">var</span> $<span class="keyword">this</span> = $(<span class="keyword">this</span>), names = funcArg(<span class="keyword">this</span>, name, idx, className(<span class="keyword">this</span>))</span><br><span class="line">     names.split(<span class="regexp">/\s+/g</span>).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">klass</span>)</span>&#123;</span><br><span class="line">       <span class="comment">// when 通过true/false控制</span></span><br><span class="line">       (when === <span class="literal">undefined</span> ? !$<span class="keyword">this</span>.hasClass(klass) : when) ?</span><br><span class="line">         $<span class="keyword">this</span>.addClass(klass) : $<span class="keyword">this</span>.removeClass(klass)</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> scrollTop: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">this</span>.length) <span class="keyword">return</span></span><br><span class="line">   <span class="keyword">var</span> hasScrollTop = <span class="string">'scrollTop'</span> <span class="keyword">in</span> <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">   <span class="keyword">if</span> (value === <span class="literal">undefined</span>) <span class="keyword">return</span> hasScrollTop ? <span class="keyword">this</span>[<span class="number">0</span>].scrollTop : <span class="keyword">this</span>[<span class="number">0</span>].pageYOffset</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(hasScrollTop ?</span><br><span class="line">     <span class="comment">// 支持scrollTop，直接赋值</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.scrollTop = value &#125; :</span><br><span class="line">     <span class="comment">// 不支持scrollTop，滚到指定坐标  pageYOffset 属性是 scrollY 属性的别名 pageYOffset兼容更好</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.scrollTo(<span class="keyword">this</span>.scrollX, value) &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> scrollLeft: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">this</span>.length) <span class="keyword">return</span></span><br><span class="line">   <span class="keyword">var</span> hasScrollLeft = <span class="string">'scrollLeft'</span> <span class="keyword">in</span> <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">   <span class="keyword">if</span> (value === <span class="literal">undefined</span>) <span class="keyword">return</span> hasScrollLeft ? <span class="keyword">this</span>[<span class="number">0</span>].scrollLeft : <span class="keyword">this</span>[<span class="number">0</span>].pageXOffset</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.each(hasScrollLeft ?</span><br><span class="line">     <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.scrollLeft = value &#125; :</span><br><span class="line">     <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="keyword">this</span>.scrollTo(value, <span class="keyword">this</span>.scrollY) &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"> position: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">this</span>.length) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> elem = <span class="keyword">this</span>[<span class="number">0</span>],</span><br><span class="line">     <span class="comment">// Get *real* offsetParent</span></span><br><span class="line">     <span class="comment">// 读到父元素</span></span><br><span class="line">     offsetParent = <span class="keyword">this</span>.offsetParent(),</span><br><span class="line">     <span class="comment">// Get correct offsets</span></span><br><span class="line">     <span class="comment">// 读到坐标</span></span><br><span class="line">     offset       = <span class="keyword">this</span>.offset(),</span><br><span class="line">     <span class="comment">// 读到父元素的坐标</span></span><br><span class="line">     parentOffset = rootNodeRE.test(offsetParent[<span class="number">0</span>].nodeName) ? &#123; <span class="attr">top</span>: <span class="number">0</span>, <span class="attr">left</span>: <span class="number">0</span> &#125; : offsetParent.offset()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Subtract element margins</span></span><br><span class="line">   <span class="comment">// note: when an element has margin: auto the offsetLeft and marginLeft</span></span><br><span class="line">   <span class="comment">// are the same in Safari causing offset.left to incorrectly be 0</span></span><br><span class="line">   <span class="comment">// 坐标减去外边框</span></span><br><span class="line">   offset.top  -= <span class="built_in">parseFloat</span>( $(elem).css(<span class="string">'margin-top'</span>) ) || <span class="number">0</span></span><br><span class="line">   offset.left -= <span class="built_in">parseFloat</span>( $(elem).css(<span class="string">'margin-left'</span>) ) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Add offsetParent borders</span></span><br><span class="line">   <span class="comment">// 加上父元素的border</span></span><br><span class="line">   parentOffset.top  += <span class="built_in">parseFloat</span>( $(offsetParent[<span class="number">0</span>]).css(<span class="string">'border-top-width'</span>) ) || <span class="number">0</span></span><br><span class="line">   parentOffset.left += <span class="built_in">parseFloat</span>( $(offsetParent[<span class="number">0</span>]).css(<span class="string">'border-left-width'</span>) ) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Subtract the two offsets</span></span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     top:  offset.top  - parentOffset.top,</span><br><span class="line">     left: offset.left - parentOffset.left</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br><span class="line"> offsetParent: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 返回第一个匹配元素用于定位的祖先元素</span></span><br><span class="line"><span class="comment">  * 原理：读取父元素中第一个其position设为relative或absolute的可见元素</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="comment">// 读取定位父元素，没有，则body</span></span><br><span class="line">     <span class="keyword">var</span> parent = <span class="keyword">this</span>.offsetParent || <span class="built_in">document</span>.body</span><br><span class="line">     <span class="comment">// 如果找到的定位元素  position='static'继续往上找，直到body/Html</span></span><br><span class="line">     <span class="keyword">while</span> (parent &amp;&amp; !rootNodeRE.test(parent.nodeName) &amp;&amp; $(parent).css(<span class="string">"position"</span>) == <span class="string">"static"</span>)</span><br><span class="line">       parent = parent.offsetParent</span><br><span class="line">     <span class="keyword">return</span> parent</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://userkang.com/2018/06/22/zepto源码阅读第四天/" data-id="cjsahc9mr00094czd668nc1cb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zepto/">zepto</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zepto源码阅读第三天" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/11/zepto源码阅读第三天/" class="article-date">
  <time datetime="2018-06-10T19:56:36.000Z" itemprop="datePublished">2018-06-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/11/zepto源码阅读第三天/">zepto源码阅读第三天</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天准备把 <code>$.fn</code> 上的函数对照 API 文档过一下。由于函数过多，就不一一记录了，就把觉得重要的记录下来吧。</p>
<p>zepto API  在线文档地址：</p>
<p>英文版：<a href="http://zeptojs.com/" target="_blank" rel="noopener">http://zeptojs.com/</a><br>中文版：<a href="http://www.css88.com/doc/zeptojs_api/" target="_blank" rel="noopener">http://www.css88.com/doc/zeptojs_api/</a></p>
<p>1、直接继承原声js的几个方法</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">forEach: emptyArray<span class="selector-class">.forEach</span>,</span><br><span class="line">reduce: emptyArray<span class="selector-class">.reduce</span>,</span><br><span class="line">push: emptyArray<span class="selector-class">.push</span>,</span><br><span class="line">sort: emptyArray<span class="selector-class">.sort</span>,</span><br><span class="line">splice: emptyArray<span class="selector-class">.splice</span>,</span><br><span class="line">indexOf: emptyArray<span class="selector-class">.indexOf</span>,</span><br></pre></td></tr></table></figure>
<p>2、concat</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">concat: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> i, value, args = []</span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">     value = <span class="built_in">arguments</span>[i]</span><br><span class="line">     args[i] = zepto.isZ(value) ? value.toArray() : value</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> concat.apply(zepto.isZ(<span class="keyword">this</span>) ? <span class="keyword">this</span>.toArray() : <span class="keyword">this</span>, args)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果发现 value 是 zepto 对象，就把它转成数组。<code>toArray</code> 函数内部大概用 <code>[].slice.call()</code> 的方式把类数组转为数组，ES6中已经有 <code>Array.from</code> 方法可以实现同样的功能了哈。</p>
<p>3、map</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">map: <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> $($.map(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params">el, i</span>)</span>&#123; <span class="keyword">return</span> fn.call(el, i, el) &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$.map = <span class="function"><span class="keyword">function</span>(<span class="params">elements, callback</span>)</span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(callback)</span><br><span class="line">   <span class="keyword">var</span> value, values = [], i, key</span><br><span class="line">   <span class="keyword">if</span> (likeArray(elements))</span><br><span class="line">     <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">       value = callback(elements[i], i)</span><br><span class="line">       <span class="keyword">if</span> (value != <span class="literal">null</span>) values.push(value)</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     <span class="keyword">for</span> (key <span class="keyword">in</span> elements) &#123;</span><br><span class="line">       value = callback(elements[key], key)</span><br><span class="line">       <span class="keyword">if</span> (value != <span class="literal">null</span>) values.push(value)</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="keyword">return</span> flatten(values)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里 <code>$.map(this, function(el, i){ return fn.call(el, i, el) })</code> 得注意下</p>
<p>情况一： <code>$.map([], function(value, key))</code> ，<code>value</code> 在前，<code>key</code> 在后。<br>情况二： <code>$(&#39;xx&#39;).map(function(key, value))</code> 这种的，<code>key</code> 在前，<code>value</code> 在后。<br><code>fn.call(el, i, el)</code> 看这就可以知道，将参数做了调换。第一个 <code>el</code> 是上下文。后面两个参数就是 <code>key 和 value</code> 的值了。</p>
<p>4、ready</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ready: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// don't use "interactive" on IE &lt;= 10 (it can fired premature)</span></span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">"complete"</span> ||</span><br><span class="line">         (<span class="built_in">document</span>.readyState !== <span class="string">"loading"</span> &amp;&amp; !<span class="built_in">document</span>.documentElement.doScroll))</span><br><span class="line">       setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; callback($) &#125;, <span class="number">0</span>)</span><br><span class="line">     <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">var</span> handler = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="built_in">document</span>.removeEventListener(<span class="string">"DOMContentLoaded"</span>, handler, <span class="literal">false</span>)</span><br><span class="line">         <span class="built_in">window</span>.removeEventListener(<span class="string">"load"</span>, handler, <span class="literal">false</span>)</span><br><span class="line">         callback($)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">document</span>.addEventListener(<span class="string">"DOMContentLoaded"</span>, handler, <span class="literal">false</span>)</span><br><span class="line">       <span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, handler, <span class="literal">false</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文档加载的几个状态：</p>
<blockquote>
<p>“uninitialized” – 原始状态<br>“loading” – 下载数据中..<br>“loaded” – 下载完成<br>“interactive” – 还未执行完毕.<br>“complete” – 脚本执行完毕</p>
</blockquote>
<p>大概的执行顺序：</p>
<ul>
<li>document.readyState 为 loading </li>
<li>触发DOMContentLoaded事件，监听DOMContentLoaded要执行的函数</li>
<li>document.documentElement.doScroll （IE）</li>
<li>document.readyState 为compelete </li>
<li>onload函数（资源加载完毕）</li>
</ul>
<p>这里为了兼容，做了很多处理。目的是为了在DOM树构建完成的第一时间就能执行代码。<br>如果支持 DOMContentLoaded 事件，那最好不过。<br>如果不支持（IE），就只能通过检测 doScroll 或者 监听文档加载的状态来判断页面DOM树是否已经构建完成。</p>
<p>简单写个例子验证了下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'readystatechange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">'loading'</span>) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'loading'</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.readyState === <span class="string">'complete'</span>) &#123;</span><br><span class="line">	    <span class="built_in">console</span>.log(<span class="string">'complete'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'DOMContentLoaded'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'load'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>今天就到这了，下篇继续。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://userkang.com/2018/06/11/zepto源码阅读第三天/" data-id="cjsahc9m700014czd9rnjmfce" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zepto/">zepto</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zepto源码阅读第二天" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/10/zepto源码阅读第二天/" class="article-date">
  <time datetime="2018-06-10T14:11:21.000Z" itemprop="datePublished">2018-06-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/10/zepto源码阅读第二天/">zepto源码阅读第二天</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上次说到了zepto.Z函数，下面继续哈。</p>
<p>一、zepto.Z 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Z</span>(<span class="params">dom, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i, len = dom ? dom.length : <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) <span class="keyword">this</span>[i] = dom[i]</span><br><span class="line">  <span class="keyword">this</span>.length = len   <span class="comment">// length属性在这里赋值</span></span><br><span class="line">  <span class="keyword">this</span>.selector = selector || <span class="string">''</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// `zepto.Z` 用 `$.fn` 替换了自己的 prototype 属性</span></span><br><span class="line"><span class="comment">// 这样实例化的dom对象就拥有了挂载在$.fn的方法</span></span><br><span class="line">zepto.Z = <span class="function"><span class="keyword">function</span>(<span class="params">dom, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Z(dom, selector)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>Z</code> 函数是一个内部方法，是不希望暴露出来被修改的。</p>
<p>二、$.fn 函数</p>
<p>上面说到 <code>zepto.Z</code> 用 <code>$.fn</code> 替换了自己的 prototype 属性，代码在这里：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zepto.Z.prototype = Z.prototype = $.fn</span><br></pre></td></tr></table></figure>
<p>如果要实现让实例对象拥有 <code>$.fn</code> 上的方法，其实这里用 <code>Z.prototype = $.fn</code> 就可以实现了,这里的 zepto.Z.prototype 有什么意义呢？在 <code>v1.1.6</code> 版之前因为还没有 <code>Z</code> 函数，当时的版本里是通过将实例的 <code>__proto__</code>  直接指向 <code>$.fn</code> 来实现继承的。<br>所以当时的 <code>isZ</code> 函数内部用 <code>zepto.Z</code> 来判断一个实例是否是 <code>zepto</code> 对象，这样是很好理解的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zepto.isZ = <span class="function"><span class="keyword">function</span>(<span class="params">object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> object <span class="keyword">instanceof</span> zepto.Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么现在有了 <code>Z</code> 函数，这里可以改成 <code>object instanceof Z</code> 了吧。</p>
<p>至于为什么还保留 <code>zepto.Z.prototype</code> 我有几个猜想哈</p>
<p>1、历史原因 </p>
<p>或许之前有很多人这样用？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$().__proto__ === $.zepto.Z.prototype</span><br></pre></td></tr></table></figure>
<p>在 <code>Z</code> 函数没有暴露的情况下，不能使用 <code>$().__proto__ === $.Z.prototype</code>  这样的操作。</p>
<p>二、本来就是这样设计的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$.fn = &#123;</span><br><span class="line">  <span class="keyword">constructor</span>: zepto.Z,</span><br><span class="line">  length: 0,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里可以看到 <code>$.fn</code> 将 constructor 重新指向 zepto.Z 构造函数，而不是 Z。也可以看出设计本身就希望 Z 仅仅是一个工厂方法，引入它是希望优化掉 <code>__proto__</code> 这种不优雅的写法，不想改动原有的设计。</p>
<p>或许 <code>zepto.Z.prototype</code> 的存在还有其他原因吧，我上面说的就是记录下来，等待未来的某一天打脸用的。哈哈。</p>
<p>有些跑偏了，下篇还是继续来看 <code>$.fn</code> 函数吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://userkang.com/2018/06/10/zepto源码阅读第二天/" data-id="cjsahc9mb00034czd8wtbtmwu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zepto/">zepto</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zepto源码阅读第一天" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/04/zepto源码阅读第一天/" class="article-date">
  <time datetime="2018-06-03T18:00:01.000Z" itemprop="datePublished">2018-06-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/04/zepto源码阅读第一天/">zepto源码阅读第一天</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="zepto">zepto</a> github地址：<a href="git@github.com:madrobby/zepto.git">git@github.com:madrobby/zepto.git</a></p>
<p>看到目录结构后，找到 src/zepto.js</p>
<p>1、代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Zepto = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;...&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Zepto = Zepto</span><br><span class="line"><span class="built_in">window</span>.$ === <span class="literal">undefined</span> &amp;&amp; (<span class="built_in">window</span>.$ = Zepto)</span><br></pre></td></tr></table></figure>
<p>这里使用 IDE 折叠代码可以清楚的看到整个代码结构。如果项目中 $ 符被占用，可以使用Zepto来调用。</p>
<p>2、代码入口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ = <span class="function"><span class="keyword">function</span>(<span class="params">selector, context</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> zepto.init(selector, context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>平时项目中都是通过 $(xx) 的方式调用的。看来这里是调用了 init 函数，那再看看init函数里是什么吧？</p>
<p>3、zepto.init 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">zepto.init = <span class="function"><span class="keyword">function</span>(<span class="params">selector, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> dom</span><br><span class="line">  <span class="comment">// 如果selector为空，就返回一个空的Zepto对象</span></span><br><span class="line">  <span class="keyword">if</span> (!selector) <span class="keyword">return</span> zepto.Z()</span><br><span class="line">  <span class="comment">// 判断selector是否是字符串</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> selector == <span class="string">'string'</span>) &#123;</span><br><span class="line"> <span class="comment">// 过滤空白字符</span></span><br><span class="line">    selector = selector.trim()</span><br><span class="line">    <span class="comment">// 如果是一个html片段，就创建一个Dom节点</span></span><br><span class="line">    <span class="comment">// 注意: 在谷歌21和火狐15版本的浏览器中，如果html片断不是以'&lt;'开始会报异常</span></span><br><span class="line">    <span class="keyword">if</span> (selector[<span class="number">0</span>] == <span class="string">'&lt;'</span> &amp;&amp; fragmentRE.test(selector))</span><br><span class="line">      dom = zepto.fragment(selector, <span class="built_in">RegExp</span>.$<span class="number">1</span>, context), selector = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 如果传了上下文的参数，会先创建一个上下文集合，然后在这个集合内去寻找selector节点</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (context !== <span class="literal">undefined</span>) <span class="keyword">return</span> $(context).find(selector)</span><br><span class="line">    <span class="comment">// 如果是CSS选择器，直接调用原生querySelectorAll去寻找节点(当然qsa方法里面做了很多东西，先这样理解)</span></span><br><span class="line">    <span class="keyword">else</span> dom = zepto.qsa(<span class="built_in">document</span>, selector)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果传入的是一个方法，则调用Dom ready的方法</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (isFunction(selector)) <span class="keyword">return</span> $(<span class="built_in">document</span>).ready(selector)</span><br><span class="line">  <span class="comment">// 如果本身传入的就是一个Zepto对象，就直接返回这个对象</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (zepto.isZ(selector)) <span class="keyword">return</span> selector</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果传入的selector是一个节点数组，就格式化下数组，清除里面的空对象</span></span><br><span class="line">    <span class="keyword">if</span> (isArray(selector)) dom = compact(selector)</span><br><span class="line">    <span class="comment">// 如果传入是一个对象，就把它包成一个数组</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isObject(selector))</span><br><span class="line">      dom = [selector], selector = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 下面的操作和上面的类似，就不多说了</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fragmentRE.test(selector))</span><br><span class="line">      dom = zepto.fragment(selector.trim(), <span class="built_in">RegExp</span>.$<span class="number">1</span>, context), selector = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (context !== <span class="literal">undefined</span>) <span class="keyword">return</span> $(context).find(selector)</span><br><span class="line">    <span class="keyword">else</span> dom = zepto.qsa(<span class="built_in">document</span>, selector)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 最后将生成的Dom和选择器传入Z函数</span></span><br><span class="line">  <span class="keyword">return</span> zepto.Z(dom, selector)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就要看看 zepto.Z 函数里面发生了什么。期待。</p>
<p>在 zepto.init 函数中用很多工具方法，都很有意思。比如 fragment、qsa、compact 等。以后再细细展开，今天就先到这啦。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://userkang.com/2018/06/04/zepto源码阅读第一天/" data-id="cjsahc9m100004czdld0glunf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zepto/">zepto</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/22/zepto源码阅读第四天/">zepto源码阅读第四天</a>
          </li>
        
          <li>
            <a href="/2018/06/11/zepto源码阅读第三天/">zepto源码阅读第三天</a>
          </li>
        
          <li>
            <a href="/2018/06/10/zepto源码阅读第二天/">zepto源码阅读第二天</a>
          </li>
        
          <li>
            <a href="/2018/06/04/zepto源码阅读第一天/">zepto源码阅读第一天</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/zepto/">zepto</a><span class="tag-list-count">4</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 userkang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>



  </div>
</body>
</html>